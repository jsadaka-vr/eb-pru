{
 "Resources": {
  "ebtestserviceroleC9BF3597": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-service-role/Resource"
   }
  },
  "ebtestserviceroleDefaultPolicy26B52B76": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "s3:GetObject",
        "s3:ListObjects",
        "s3:PutObject"
       ],
       "Effect": "Allow",
       "Resource": [
        "arn:aws:s3:::ebap-begin",
        "arn:aws:s3:::ebap-begin/*",
        "arn:aws:s3:::ebap-test",
        "arn:aws:s3:::ebap-test/*",
        {
         "Fn::GetAtt": [
          "ebtestsourcebucketB1DEEE4A",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "ebtestsourcebucketB1DEEE4A",
             "Arn"
            ]
           },
           "/*"
          ]
         ]
        }
       ]
      },
      {
       "Action": [
        "kms:Decrypt",
        "kms:Encrypt",
        "kms:GenerateDataKey"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ebtestkeyFA6456B8",
         "Arn"
        ]
       }
      },
      {
       "Action": [
        "ecr:*",
        "eks:*"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "ec2:DescribeInstances",
        "ec2:RunInstances",
        "ec2:StartInstances",
        "ec2:StopInstances",
        "ec2:TerminateInstances"
       ],
       "Condition": {
        "StringEquals": {
         "ec2:ResourceTag/Type": "Resiliency"
        }
       },
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "states:DescribeActivity",
        "states:DescribeExecution",
        "states:DescribeStateMachine",
        "states:GetExecutionHistory",
        "states:ListActivities",
        "states:ListExecutions",
        "states:ListStateMachines",
        "states:StartExecution"
       ],
       "Condition": {
        "StringEquals": {
         "aws:ResourceTag/Type": "RegressionTesting"
        }
       },
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "ssm:GetParameter*",
        "ssm:GetParameters*",
        "ssm:GetParametersByPath*"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          "arn:aws:ssm:",
          {
           "Ref": "AWS::Region"
          },
          ":",
          {
           "Ref": "AWS::AccountId"
          },
          ":parameter/RegressionTesting*"
         ]
        ]
       }
      },
      {
       "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ebtestpayloadprocessorloggroup86D1ED75",
         "Arn"
        ]
       }
      },
      {
       "Action": "states:SendTaskSuccess",
       "Effect": "Allow",
       "Resource": {
        "Ref": "ebtestStateMachine249346BD"
       }
      },
      {
       "Action": [
        "ssm:ListCommandInvocations",
        "ssm:SendCommand"
       ],
       "Effect": "Allow",
       "Resource": "arn:aws:ssm:*:*:document/eb-test-*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "ebtestserviceroleDefaultPolicy26B52B76",
    "Roles": [
     {
      "Ref": "ebtestserviceroleC9BF3597"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-service-role/DefaultPolicy/Resource"
   }
  },
  "ebtestlambdaroleDE103BD1": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-lambda-role/Resource"
   }
  },
  "ebtestlambdaroleDefaultPolicy2F38B516": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "states:DescribeStateMachine",
        "states:SendTaskSuccess",
        "states:StartExecution"
       ],
       "Effect": "Allow",
       "Resource": {
        "Ref": "ebtestStateMachine249346BD"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "ebtestlambdaroleDefaultPolicy2F38B516",
    "Roles": [
     {
      "Ref": "ebtestlambdaroleDE103BD1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-lambda-role/DefaultPolicy/Resource"
   }
  },
  "ebtestkeyFA6456B8": {
   "Type": "AWS::KMS::Key",
   "Properties": {
    "KeyPolicy": {
     "Statement": [
      {
       "Action": "kms:*",
       "Effect": "Allow",
       "Principal": {
        "AWS": {
         "Fn::Join": [
          "",
          [
           "arn:",
           {
            "Ref": "AWS::Partition"
           },
           ":iam::",
           {
            "Ref": "AWS::AccountId"
           },
           ":root"
          ]
         ]
        }
       },
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-key/Resource"
   }
  },
  "ebtestsourcebucketB1DEEE4A": {
   "Type": "AWS::S3::Bucket",
   "Properties": {
    "BucketEncryption": {
     "ServerSideEncryptionConfiguration": [
      {
       "ServerSideEncryptionByDefault": {
        "KMSMasterKeyID": {
         "Fn::GetAtt": [
          "ebtestkeyFA6456B8",
          "Arn"
         ]
        },
        "SSEAlgorithm": "aws:kms"
       }
      }
     ]
    },
    "BucketName": "eb-test-source",
    "PublicAccessBlockConfiguration": {
     "BlockPublicAcls": true,
     "BlockPublicPolicy": true,
     "IgnorePublicAcls": true,
     "RestrictPublicBuckets": true
    },
    "Tags": [
     {
      "Key": "aws-cdk:auto-delete-objects",
      "Value": "true"
     },
     {
      "Key": "aws-cdk:cr-owned:experiments/:f44bcec5",
      "Value": "true"
     }
    ]
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-source-bucket/Resource"
   }
  },
  "ebtestsourcebucketPolicyAB5B77FC": {
   "Type": "AWS::S3::BucketPolicy",
   "Properties": {
    "Bucket": {
     "Ref": "ebtestsourcebucketB1DEEE4A"
    },
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "s3:*",
       "Condition": {
        "Bool": {
         "aws:SecureTransport": "false"
        }
       },
       "Effect": "Deny",
       "Principal": {
        "AWS": "*"
       },
       "Resource": [
        {
         "Fn::GetAtt": [
          "ebtestsourcebucketB1DEEE4A",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "ebtestsourcebucketB1DEEE4A",
             "Arn"
            ]
           },
           "/*"
          ]
         ]
        }
       ]
      },
      {
       "Action": [
        "s3:DeleteObject*",
        "s3:GetBucket*",
        "s3:List*",
        "s3:PutBucketPolicy"
       ],
       "Effect": "Allow",
       "Principal": {
        "AWS": {
         "Fn::GetAtt": [
          "CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092",
          "Arn"
         ]
        }
       },
       "Resource": [
        {
         "Fn::GetAtt": [
          "ebtestsourcebucketB1DEEE4A",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "ebtestsourcebucketB1DEEE4A",
             "Arn"
            ]
           },
           "/*"
          ]
         ]
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-source-bucket/Policy/Resource"
   }
  },
  "ebtestsourcebucketAutoDeleteObjectsCustomResourceAF384754": {
   "Type": "Custom::S3AutoDeleteObjects",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F",
      "Arn"
     ]
    },
    "BucketName": {
     "Ref": "ebtestsourcebucketB1DEEE4A"
    }
   },
   "DependsOn": [
    "ebtestsourcebucketPolicyAB5B77FC"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-source-bucket/AutoDeleteObjectsCustomResource/Default"
   }
  },
  "ebtestsourcebucketNotificationsF71F5595": {
   "Type": "Custom::S3BucketNotifications",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "BucketNotificationsHandler050a0587b7544547bf325f094a3db8347ECC3691",
      "Arn"
     ]
    },
    "BucketName": {
     "Ref": "ebtestsourcebucketB1DEEE4A"
    },
    "NotificationConfiguration": {
     "LambdaFunctionConfigurations": [
      {
       "Events": [
        "s3:ObjectCreated:*"
       ],
       "Filter": {
        "Key": {
         "FilterRules": [
          {
           "Name": "prefix",
           "Value": "journals/"
          }
         ]
        }
       },
       "LambdaFunctionArn": {
        "Fn::GetAtt": [
         "ebtestjirawriterB6B35CF2",
         "Arn"
        ]
       }
      }
     ]
    },
    "Managed": true
   },
   "DependsOn": [
    "ebtestsourcebucketAllowBucketNotificationsToExperimentBrokerStackebtestjirawriter9094D85E4BB3D324"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-source-bucket/Notifications/Resource"
   }
  },
  "ebtestsourcebucketAllowBucketNotificationsToExperimentBrokerStackebtestjirawriter9094D85E4BB3D324": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "ebtestjirawriterB6B35CF2",
      "Arn"
     ]
    },
    "Principal": "s3.amazonaws.com",
    "SourceAccount": {
     "Ref": "AWS::AccountId"
    },
    "SourceArn": {
     "Fn::GetAtt": [
      "ebtestsourcebucketB1DEEE4A",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-source-bucket/AllowBucketNotificationsToExperimentBrokerStackebtestjirawriter9094D85E"
   }
  },
  "CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Version": "2012-10-17",
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ]
    },
    "ManagedPolicyArns": [
     {
      "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/Custom::S3AutoDeleteObjectsCustomResourceProvider/Role"
   }
  },
  "CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": {
      "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
     },
     "S3Key": "b7f33614a69548d6bafe224d751a7ef238cde19097415e553fe8b63a4c8fd8a6.zip"
    },
    "Timeout": 900,
    "MemorySize": 128,
    "Handler": "index.handler",
    "Role": {
     "Fn::GetAtt": [
      "CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092",
      "Arn"
     ]
    },
    "Runtime": "nodejs18.x",
    "Description": {
     "Fn::Join": [
      "",
      [
       "Lambda function for auto-deleting objects in ",
       {
        "Ref": "ebtestsourcebucketB1DEEE4A"
       },
       " S3 bucket."
      ]
     ]
    }
   },
   "DependsOn": [
    "CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/Custom::S3AutoDeleteObjectsCustomResourceProvider/Handler",
    "aws:asset:path": "asset.b7f33614a69548d6bafe224d751a7ef238cde19097415e553fe8b63a4c8fd8a6",
    "aws:asset:property": "Code"
   }
  },
  "ExperimentTestFileDeploymentAwsCliLayerA54B082D": {
   "Type": "AWS::Lambda::LayerVersion",
   "Properties": {
    "Content": {
     "S3Bucket": {
      "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
     },
     "S3Key": "3322b7049fb0ed2b7cbb644a2ada8d1116ff80c32dca89e6ada846b5de26f961.zip"
    },
    "Description": "/opt/awscli/aws"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/ExperimentTestFileDeployment/AwsCliLayer/Resource",
    "aws:asset:path": "asset.3322b7049fb0ed2b7cbb644a2ada8d1116ff80c32dca89e6ada846b5de26f961.zip",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Content"
   }
  },
  "ExperimentTestFileDeploymentCustomResourceDAD2AEE8": {
   "Type": "Custom::CDKBucketDeployment",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536",
      "Arn"
     ]
    },
    "SourceBucketNames": [
     {
      "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
     }
    ],
    "SourceObjectKeys": [
     "daa64027c15210be911a56cefc162ea6922f203f908145f8335f232d5f40c788.zip"
    ],
    "DestinationBucketName": {
     "Ref": "ebtestsourcebucketB1DEEE4A"
    },
    "DestinationBucketKeyPrefix": "experiments/",
    "Prune": true,
    "SystemMetadata": {
     "content-type": "text/plain"
    }
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/ExperimentTestFileDeployment/CustomResource/Default"
   }
  },
  "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/Custom::CDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C/ServiceRole/Resource"
   }
  },
  "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "s3:GetBucket*",
        "s3:GetObject*",
        "s3:List*"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::Join": [
          "",
          [
           "arn:",
           {
            "Ref": "AWS::Partition"
           },
           ":s3:::",
           {
            "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
           },
           "/*"
          ]
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           "arn:",
           {
            "Ref": "AWS::Partition"
           },
           ":s3:::",
           {
            "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
           }
          ]
         ]
        }
       ]
      },
      {
       "Action": [
        "s3:Abort*",
        "s3:DeleteObject*",
        "s3:GetBucket*",
        "s3:GetObject*",
        "s3:List*",
        "s3:PutObject",
        "s3:PutObjectLegalHold",
        "s3:PutObjectRetention",
        "s3:PutObjectTagging",
        "s3:PutObjectVersionTagging"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "ebtestsourcebucketB1DEEE4A",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "ebtestsourcebucketB1DEEE4A",
             "Arn"
            ]
           },
           "/*"
          ]
         ]
        }
       ]
      },
      {
       "Action": [
        "kms:Decrypt",
        "kms:DescribeKey",
        "kms:Encrypt",
        "kms:GenerateDataKey*",
        "kms:ReEncrypt*"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ebtestkeyFA6456B8",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
    "Roles": [
     {
      "Ref": "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/Custom::CDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C81C01536": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": {
      "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
     },
     "S3Key": "e976a796f036a5efbf44b99e44cfb5a961df08d8dbf7cd37e60bf216fb982a00.zip"
    },
    "Environment": {
     "Variables": {
      "AWS_CA_BUNDLE": "/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem"
     }
    },
    "Handler": "index.handler",
    "Layers": [
     {
      "Ref": "ExperimentTestFileDeploymentAwsCliLayerA54B082D"
     }
    ],
    "Role": {
     "Fn::GetAtt": [
      "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265",
      "Arn"
     ]
    },
    "Runtime": "python3.9",
    "Timeout": 900
   },
   "DependsOn": [
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRoleDefaultPolicy88902FDF",
    "CustomCDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756CServiceRole89A01265"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/Custom::CDKBucketDeployment8693BB64968944B69AAFB0CC9EB8756C/Resource",
    "aws:asset:path": "asset.e976a796f036a5efbf44b99e44cfb5a961df08d8dbf7cd37e60bf216fb982a00",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "ebtestVpcC4244F9D": {
   "Type": "AWS::EC2::VPC",
   "Properties": {
    "CidrBlock": "42.0.0.0/16",
    "EnableDnsHostnames": true,
    "EnableDnsSupport": true,
    "InstanceTenancy": "default",
    "Tags": [
     {
      "Key": "Name",
      "Value": "eb-test-vpc"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/Resource"
   }
  },
  "ebtestVpcPublicSubnet1SubnetF5E82D6A": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": {
     "Fn::Select": [
      0,
      {
       "Fn::GetAZs": ""
      }
     ]
    },
    "CidrBlock": "42.0.0.0/18",
    "MapPublicIpOnLaunch": true,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Public"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Public"
     },
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1/Subnet"
   }
  },
  "ebtestVpcPublicSubnet1RouteTableA4A6732D": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1/RouteTable"
   }
  },
  "ebtestVpcPublicSubnet1RouteTableAssociation4C8AA936": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "ebtestVpcPublicSubnet1RouteTableA4A6732D"
    },
    "SubnetId": {
     "Ref": "ebtestVpcPublicSubnet1SubnetF5E82D6A"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1/RouteTableAssociation"
   }
  },
  "ebtestVpcPublicSubnet1DefaultRoute98407232": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "GatewayId": {
     "Ref": "ebtestVpcIGWEA6A5D81"
    },
    "RouteTableId": {
     "Ref": "ebtestVpcPublicSubnet1RouteTableA4A6732D"
    }
   },
   "DependsOn": [
    "ebtestVpcVPCGW7C82346A"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1/DefaultRoute"
   }
  },
  "ebtestVpcPublicSubnet1EIPAC345E83": {
   "Type": "AWS::EC2::EIP",
   "Properties": {
    "Domain": "vpc",
    "Tags": [
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1/EIP"
   }
  },
  "ebtestVpcPublicSubnet1NATGateway08088E39": {
   "Type": "AWS::EC2::NatGateway",
   "Properties": {
    "AllocationId": {
     "Fn::GetAtt": [
      "ebtestVpcPublicSubnet1EIPAC345E83",
      "AllocationId"
     ]
    },
    "SubnetId": {
     "Ref": "ebtestVpcPublicSubnet1SubnetF5E82D6A"
    },
    "Tags": [
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1"
     }
    ]
   },
   "DependsOn": [
    "ebtestVpcPublicSubnet1DefaultRoute98407232",
    "ebtestVpcPublicSubnet1RouteTableAssociation4C8AA936"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet1/NATGateway"
   }
  },
  "ebtestVpcPublicSubnet2SubnetA2B73953": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": {
     "Fn::Select": [
      1,
      {
       "Fn::GetAZs": ""
      }
     ]
    },
    "CidrBlock": "42.0.64.0/18",
    "MapPublicIpOnLaunch": true,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Public"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Public"
     },
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2/Subnet"
   }
  },
  "ebtestVpcPublicSubnet2RouteTableDD48AED1": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2/RouteTable"
   }
  },
  "ebtestVpcPublicSubnet2RouteTableAssociationC88D70F5": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "ebtestVpcPublicSubnet2RouteTableDD48AED1"
    },
    "SubnetId": {
     "Ref": "ebtestVpcPublicSubnet2SubnetA2B73953"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2/RouteTableAssociation"
   }
  },
  "ebtestVpcPublicSubnet2DefaultRoute5517E469": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "GatewayId": {
     "Ref": "ebtestVpcIGWEA6A5D81"
    },
    "RouteTableId": {
     "Ref": "ebtestVpcPublicSubnet2RouteTableDD48AED1"
    }
   },
   "DependsOn": [
    "ebtestVpcVPCGW7C82346A"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2/DefaultRoute"
   }
  },
  "ebtestVpcPublicSubnet2EIPFC65A16A": {
   "Type": "AWS::EC2::EIP",
   "Properties": {
    "Domain": "vpc",
    "Tags": [
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2/EIP"
   }
  },
  "ebtestVpcPublicSubnet2NATGateway91336E7D": {
   "Type": "AWS::EC2::NatGateway",
   "Properties": {
    "AllocationId": {
     "Fn::GetAtt": [
      "ebtestVpcPublicSubnet2EIPFC65A16A",
      "AllocationId"
     ]
    },
    "SubnetId": {
     "Ref": "ebtestVpcPublicSubnet2SubnetA2B73953"
    },
    "Tags": [
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2"
     }
    ]
   },
   "DependsOn": [
    "ebtestVpcPublicSubnet2DefaultRoute5517E469",
    "ebtestVpcPublicSubnet2RouteTableAssociationC88D70F5"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PublicSubnet2/NATGateway"
   }
  },
  "ebtestVpcPrivateSubnet1Subnet3682F178": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": {
     "Fn::Select": [
      0,
      {
       "Fn::GetAZs": ""
      }
     ]
    },
    "CidrBlock": "42.0.128.0/18",
    "MapPublicIpOnLaunch": false,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Private"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Private"
     },
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet1/Subnet"
   }
  },
  "ebtestVpcPrivateSubnet1RouteTable86FA7DBD": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet1/RouteTable"
   }
  },
  "ebtestVpcPrivateSubnet1RouteTableAssociation5C789E42": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "ebtestVpcPrivateSubnet1RouteTable86FA7DBD"
    },
    "SubnetId": {
     "Ref": "ebtestVpcPrivateSubnet1Subnet3682F178"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet1/RouteTableAssociation"
   }
  },
  "ebtestVpcPrivateSubnet1DefaultRouteF50B04E5": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "NatGatewayId": {
     "Ref": "ebtestVpcPublicSubnet1NATGateway08088E39"
    },
    "RouteTableId": {
     "Ref": "ebtestVpcPrivateSubnet1RouteTable86FA7DBD"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet1/DefaultRoute"
   }
  },
  "ebtestVpcPrivateSubnet2SubnetDE2F2B88": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": {
     "Fn::Select": [
      1,
      {
       "Fn::GetAZs": ""
      }
     ]
    },
    "CidrBlock": "42.0.192.0/18",
    "MapPublicIpOnLaunch": false,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Private"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Private"
     },
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet2/Subnet"
   }
  },
  "ebtestVpcPrivateSubnet2RouteTable2139F668": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet2/RouteTable"
   }
  },
  "ebtestVpcPrivateSubnet2RouteTableAssociationEE24090D": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "ebtestVpcPrivateSubnet2RouteTable2139F668"
    },
    "SubnetId": {
     "Ref": "ebtestVpcPrivateSubnet2SubnetDE2F2B88"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet2/RouteTableAssociation"
   }
  },
  "ebtestVpcPrivateSubnet2DefaultRouteD304388F": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "NatGatewayId": {
     "Ref": "ebtestVpcPublicSubnet2NATGateway91336E7D"
    },
    "RouteTableId": {
     "Ref": "ebtestVpcPrivateSubnet2RouteTable2139F668"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/PrivateSubnet2/DefaultRoute"
   }
  },
  "ebtestVpcIGWEA6A5D81": {
   "Type": "AWS::EC2::InternetGateway",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "eb-test-vpc"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/IGW"
   }
  },
  "ebtestVpcVPCGW7C82346A": {
   "Type": "AWS::EC2::VPCGatewayAttachment",
   "Properties": {
    "InternetGatewayId": {
     "Ref": "ebtestVpcIGWEA6A5D81"
    },
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/VPCGW"
   }
  },
  "ebtestVpcRestrictDefaultSecurityGroupCustomResource5117C1F3": {
   "Type": "Custom::VpcRestrictDefaultSG",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "CustomVpcRestrictDefaultSGCustomResourceProviderHandlerDC833E5E",
      "Arn"
     ]
    },
    "DefaultSecurityGroupId": {
     "Fn::GetAtt": [
      "ebtestVpcC4244F9D",
      "DefaultSecurityGroup"
     ]
    },
    "Account": {
     "Ref": "AWS::AccountId"
    }
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-Vpc/RestrictDefaultSecurityGroupCustomResource/Default"
   }
  },
  "CustomVpcRestrictDefaultSGCustomResourceProviderRole26592FE0": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Version": "2012-10-17",
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ]
    },
    "ManagedPolicyArns": [
     {
      "Fn::Sub": "arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
     }
    ],
    "Policies": [
     {
      "PolicyName": "Inline",
      "PolicyDocument": {
       "Version": "2012-10-17",
       "Statement": [
        {
         "Effect": "Allow",
         "Action": [
          "ec2:AuthorizeSecurityGroupIngress",
          "ec2:AuthorizeSecurityGroupEgress",
          "ec2:RevokeSecurityGroupIngress",
          "ec2:RevokeSecurityGroupEgress"
         ],
         "Resource": [
          {
           "Fn::Join": [
            "",
            [
             "arn:",
             {
              "Ref": "AWS::Partition"
             },
             ":ec2:",
             {
              "Ref": "AWS::Region"
             },
             ":",
             {
              "Ref": "AWS::AccountId"
             },
             ":security-group/",
             {
              "Fn::GetAtt": [
               "ebtestVpcC4244F9D",
               "DefaultSecurityGroup"
              ]
             }
            ]
           ]
          }
         ]
        }
       ]
      }
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/Custom::VpcRestrictDefaultSGCustomResourceProvider/Role"
   }
  },
  "CustomVpcRestrictDefaultSGCustomResourceProviderHandlerDC833E5E": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": {
      "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
     },
     "S3Key": "dd5711540f04e06aa955d7f4862fc04e8cdea464cb590dae91ed2976bb78098e.zip"
    },
    "Timeout": 900,
    "MemorySize": 128,
    "Handler": "__entrypoint__.handler",
    "Role": {
     "Fn::GetAtt": [
      "CustomVpcRestrictDefaultSGCustomResourceProviderRole26592FE0",
      "Arn"
     ]
    },
    "Runtime": "nodejs18.x",
    "Description": "Lambda function for removing all inbound/outbound rules from the VPC default security group"
   },
   "DependsOn": [
    "CustomVpcRestrictDefaultSGCustomResourceProviderRole26592FE0"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/Custom::VpcRestrictDefaultSGCustomResourceProvider/Handler",
    "aws:asset:path": "asset.dd5711540f04e06aa955d7f4862fc04e8cdea464cb590dae91ed2976bb78098e",
    "aws:asset:property": "Code"
   }
  },
  "ebtestecsclusterD26624B7": {
   "Type": "AWS::ECS::Cluster",
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-ecs-cluster/Resource"
   }
  },
  "ebtestecscluster4C700694": {
   "Type": "AWS::ECS::ClusterCapacityProviderAssociations",
   "Properties": {
    "CapacityProviders": [
     "FARGATE",
     "FARGATE_SPOT"
    ],
    "Cluster": {
     "Ref": "ebtestecsclusterD26624B7"
    },
    "DefaultCapacityProviderStrategy": []
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-ecs-cluster/eb-test-ecs-cluster"
   }
  },
  "ebtestid3A0009DB": {
   "Type": "AWS::ECR::Repository",
   "Properties": {
    "EmptyOnDelete": true,
    "ImageScanningConfiguration": {
     "ScanOnPush": true
    },
    "RepositoryName": "eb-test-payload-processor"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-id/Resource"
   }
  },
  "ebtestpayloadprocessorECA18C4F": {
   "Type": "AWS::ECS::TaskDefinition",
   "Properties": {
    "ContainerDefinitions": [
     {
      "Essential": true,
      "Image": {
       "Fn::Join": [
        "",
        [
         {
          "Fn::Select": [
           4,
           {
            "Fn::Split": [
             ":",
             {
              "Fn::GetAtt": [
               "ebtestid3A0009DB",
               "Arn"
              ]
             }
            ]
           }
          ]
         },
         ".dkr.ecr.",
         {
          "Fn::Select": [
           3,
           {
            "Fn::Split": [
             ":",
             {
              "Fn::GetAtt": [
               "ebtestid3A0009DB",
               "Arn"
              ]
             }
            ]
           }
          ]
         },
         ".",
         {
          "Ref": "AWS::URLSuffix"
         },
         "/",
         {
          "Ref": "ebtestid3A0009DB"
         },
         ":latest"
        ]
       ]
      },
      "LogConfiguration": {
       "LogDriver": "awslogs",
       "Options": {
        "awslogs-group": {
         "Ref": "ebtestpayloadprocessorloggroup86D1ED75"
        },
        "awslogs-stream-prefix": "ART-payload-processor",
        "awslogs-region": {
         "Ref": "AWS::Region"
        },
        "mode": "non-blocking"
       }
      },
      "Name": {
       "Ref": "ebtestid3A0009DB"
      }
     }
    ],
    "Cpu": "256",
    "ExecutionRoleArn": {
     "Fn::GetAtt": [
      "ebtestserviceroleC9BF3597",
      "Arn"
     ]
    },
    "Family": "ExperimentBrokerStackebtestpayloadprocessorD2B9189A",
    "Memory": "512",
    "NetworkMode": "awsvpc",
    "RequiresCompatibilities": [
     "FARGATE"
    ],
    "TaskRoleArn": {
     "Fn::GetAtt": [
      "ebtestserviceroleC9BF3597",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-payload-processor/Resource"
   }
  },
  "ebtestpayloadprocessorloggroup86D1ED75": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": "ecs/eb-test/payload-processor",
    "RetentionInDays": 731
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-payload-processor-log-group/Resource"
   }
  },
  "ebtestrunpayloadprocessorSecurityGroup2F38EAFD": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "ExperimentBrokerStack/eb-test-run-payload-processor/SecurityGroup",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "VpcId": {
     "Ref": "ebtestVpcC4244F9D"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-run-payload-processor/SecurityGroup/Resource"
   }
  },
  "ebtestStateMachineRole29312413": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "states.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test_State_Machine/Role/Resource"
   }
  },
  "ebtestStateMachineRoleDefaultPolicyF5A5995E": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "ecs:RunTask",
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          "arn:",
          {
           "Fn::Select": [
            1,
            {
             "Fn::Split": [
              ":",
              {
               "Ref": "ebtestpayloadprocessorECA18C4F"
              }
             ]
            }
           ]
          },
          ":",
          {
           "Fn::Select": [
            2,
            {
             "Fn::Split": [
              ":",
              {
               "Ref": "ebtestpayloadprocessorECA18C4F"
              }
             ]
            }
           ]
          },
          ":",
          {
           "Fn::Select": [
            3,
            {
             "Fn::Split": [
              ":",
              {
               "Ref": "ebtestpayloadprocessorECA18C4F"
              }
             ]
            }
           ]
          },
          ":",
          {
           "Fn::Select": [
            4,
            {
             "Fn::Split": [
              ":",
              {
               "Ref": "ebtestpayloadprocessorECA18C4F"
              }
             ]
            }
           ]
          },
          ":",
          {
           "Fn::Select": [
            0,
            {
             "Fn::Split": [
              "/",
              {
               "Fn::Select": [
                5,
                {
                 "Fn::Split": [
                  ":",
                  {
                   "Ref": "ebtestpayloadprocessorECA18C4F"
                  }
                 ]
                }
               ]
              }
             ]
            }
           ]
          },
          "/",
          {
           "Fn::Select": [
            1,
            {
             "Fn::Split": [
              "/",
              {
               "Fn::Select": [
                5,
                {
                 "Fn::Split": [
                  ":",
                  {
                   "Ref": "ebtestpayloadprocessorECA18C4F"
                  }
                 ]
                }
               ]
              }
             ]
            }
           ]
          }
         ]
        ]
       }
      },
      {
       "Action": [
        "ecs:DescribeTasks",
        "ecs:StopTask"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": "iam:PassRole",
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ebtestserviceroleC9BF3597",
         "Arn"
        ]
       }
      },
      {
       "Action": [
        "events:DescribeRule",
        "events:PutRule",
        "events:PutTargets"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          "arn:",
          {
           "Ref": "AWS::Partition"
          },
          ":events:",
          {
           "Ref": "AWS::Region"
          },
          ":",
          {
           "Ref": "AWS::AccountId"
          },
          ":rule/StepFunctionsGetEventsForECSTaskRule"
         ]
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "ebtestStateMachineRoleDefaultPolicyF5A5995E",
    "Roles": [
     {
      "Ref": "ebtestStateMachineRole29312413"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test_State_Machine/Role/DefaultPolicy/Resource"
   }
  },
  "ebtestStateMachine249346BD": {
   "Type": "AWS::StepFunctions::StateMachine",
   "Properties": {
    "DefinitionString": {
     "Fn::Join": [
      "",
      [
       "{\"StartAt\":\"Run_Tests\",\"States\":{\"Run_Tests\":{\"Type\":\"Choice\",\"Choices\":[{\"Variable\":\"$.Payload.state\",\"StringEquals\":\"pending\",\"Next\":\"Experiment Loop\"},{\"Variable\":\"$.Payload.state\",\"StringEquals\":\"done\",\"Next\":\"Exit\"}]},\"Experiment Loop\":{\"Type\":\"Map\",\"End\":true,\"ItemsPath\":\"$.Payload.list\",\"ItemProcessor\":{\"ProcessorConfig\":{\"Mode\":\"INLINE\"},\"StartAt\":\"Process Payload\",\"States\":{\"Process Payload\":{\"Next\":\"Post Process\",\"Catch\":[{\"ErrorEquals\":[\"States.ALL\"],\"Next\":\"Processing Failed\"}],\"Type\":\"Task\",\"ResultPath\":\"$.Payload\",\"Resource\":\"arn:",
       {
        "Ref": "AWS::Partition"
       },
       ":states:::ecs:runTask.sync\",\"Parameters\":{\"Cluster\":\"",
       {
        "Fn::GetAtt": [
         "ebtestecsclusterD26624B7",
         "Arn"
        ]
       },
       "\",\"TaskDefinition\":\"ExperimentBrokerStackebtestpayloadprocessorD2B9189A\",\"NetworkConfiguration\":{\"AwsvpcConfiguration\":{\"Subnets\":[\"",
       {
        "Ref": "ebtestVpcPrivateSubnet1Subnet3682F178"
       },
       "\",\"",
       {
        "Ref": "ebtestVpcPrivateSubnet2SubnetDE2F2B88"
       },
       "\"],\"SecurityGroups\":[\"",
       {
        "Fn::GetAtt": [
         "ebtestrunpayloadprocessorSecurityGroup2F38EAFD",
         "GroupId"
        ]
       },
       "\"]}},\"Overrides\":{\"ContainerOverrides\":[{\"Name\":\"",
       {
        "Ref": "ebtestid3A0009DB"
       },
       "\",\"Environment\":[{\"Name\":\"task_token\",\"Value.$\":\"$$.Task.Token\"},{\"Name\":\"bucket_name\",\"Value.$\":\"$.bucket_name\"},{\"Name\":\"experiment_source\",\"Value.$\":\"$.experiment_source\"},{\"Name\":\"output_bucket\",\"Value.$\":\"$.output_config.S3.bucket_name\"},{\"Name\":\"jira_exec_ticket\",\"Value.$\":\"$.jira_exec_ticket\"},{\"Name\":\"jira_test_ticket\",\"Value.$\":\"$.jira_test_ticket\"},{\"Name\":\"output_path\",\"Value.$\":\"$.output_config.S3.path\"}]}]},\"LaunchType\":\"FARGATE\",\"PlatformVersion\":\"LATEST\"}},\"Wait & Retry\":{\"Type\":\"Wait\",\"Comment\":\"wait and retry for processor task\",\"Seconds\":15,\"Next\":\"Process Payload\"},\"Post Process\":{\"Type\":\"Choice\",\"Choices\":[{\"Variable\":\"$.Payload.state\",\"StringEquals\":\"done\",\"Next\":\"Complete\"},{\"Variable\":\"$.Payload.state\",\"StringEquals\":\"pending\",\"Next\":\"Wait & Retry\"}]},\"Complete\":{\"Type\":\"Pass\",\"End\":true},\"Processing Failed\":{\"Type\":\"Fail\"}}},\"MaxConcurrency\":1},\"Exit\":{\"Type\":\"Pass\",\"End\":true}}}"
      ]
     ]
    },
    "RoleArn": {
     "Fn::GetAtt": [
      "ebtestStateMachineRole29312413",
      "Arn"
     ]
    },
    "StateMachineName": "eb-test-State_Machine"
   },
   "DependsOn": [
    "ebtestStateMachineRoleDefaultPolicyF5A5995E",
    "ebtestStateMachineRole29312413"
   ],
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test_State_Machine/Resource"
   }
  },
  "ebtestgpnBlackHoleByURL": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Block access to a group of URLs on an instance",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The duration - in seconds - of the attack. (Required)",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "urls": {
       "type": "String",
       "description": "The urls you want to block, separated by a space"
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "name": "RevertCommandScheduling",
       "inputs": {}
      },
      {
       "action": "aws:runShellScript",
       "name": "AlterIptables",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\n\nfor url in {{ urls }}; do\n  iptables -I OUTPUT 1 -d $url -j DROP;\n  iptables -I FORWARD 1 -d $url -j DROP; \n  iptables -t mangle -I OUTPUT 1 -d $url -j DROP;\n  iptables -t mangle -I FORWARD 1 -d $url -j DROP;\n  done"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-gpnBlackHoleByURL"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-gpnBlackHoleByURL"
   }
  },
  "ebtestDeletePod": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "schemaVersion": "2.2",
     "description": "### Document name - AWSFIS-Run-PacketLoss\n## What does this document do?\n## Output Parameters\nNone.\n",
     "parameters": {
      "namespace": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "resiliency"
      },
      "podNamePattern": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z-]{1,128}$",
       "default": "authplugincontainer"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "name": "deletePod",
       "description": "## Parameters: Portnumber,Time\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "kubectl get pods -n {{ namespace }} --no-headers=true | awk '/{{ podNamePattern }}/{print $2}' | awk 'NR==1{print $1}' | xargs kubectl -n {{ namespace }}  delete pod\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-DeletePod"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-DeletePod"
   }
  },
  "ebtestBlockNetworkTrafficOnInstance": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Block all network traffice on an instance (i.e., create a Black Hole)",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The amount of time (in minutes) for which the network traffic will be blocked.",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.  In this case iptables is being installed and an attempt is\nmade to start the service.  iptables should always be installed on the os by default, so this should never happen.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which iptables 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install iptables-services\n      sudo systemctl start iptables\n      sudo systemctl start ip6tables\n      sudo systemctl enable iptables\n      sudo systemctl enable ip6tables\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y iptables\n    sudo ufw enable\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "blockAllNetworkTraffic",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "sudo /sbin/iptables -F\nsudo /sbin/iptables -A INPUT -i eth0 -j DROP\nsudo /sbin/iptables -A OUTPUT -i eth0 -j DROP\nsudo /sbin/iptables -A FORWARD -i eth0 -j DROP"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-BlockNetworkTrafficOnInstance"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-BlockNetworkTrafficOnInstance"
   }
  },
  "ebtestPodStressCPU": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Performs a cpu stress test on one or 2 Core DNS Containers\n on an instance via utilizing the stress-ng tool.\n## Input Parameters\n* Duration: The duration - in seconds - of the memory stress (default: 60).\n* cpu: Specify the number of CPU stressors to use (default 0 = all)\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).\n",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The amount of time which for memory will be stressed in seconds. (Required)",
       "default": "60"
      },
      "cpu": {
       "type": "String",
       "description": "Specify the number of CPU stressors to use (default: 0 which means \"all CPUs\")",
       "default": "0",
       "allowedPattern": "^[0-9]+$"
      },
      "containerNamePattern": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z_]{1,128}$",
       "default": "k8s_coredns"
      },
      "numContainersToTarget": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "1"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.  In this case iptables is being installed and an attempt is\nmade to start the service.  iptables should always be installed on the os by default, so this should never happen.\n",
       "inputs": {
        "runCommand": [
         "",
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which stress-ng 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install stress-ng\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y stress-ng\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "StressCPU",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 180,
        "runCommand": [
         "sudo -s -H <<'EOF'\n\nif [ {{ duration }} -lt 1 ] || [ {{ duration }} -gt 43200 ] ; then echo Duration parameter value must be between 1 and 43200 seconds && exit; fi\n\necho {{ containerNamePattern }}\n\nfirstPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==1{print $1}' | sed 's/,//')\necho \"${firstPid}\"\nsecondPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==2{print $1}' | sed 's/,//')\necho \"${secondPid}\"\n\nif [ -z \"$firstPid\" ]\nthen\n  echo \"firstPid is NULL\"\n  exit 0\nfi\n\necho Initiating CPU stress for {{ duration }} seconds...\n\nnsenter -t ${firstPid} -n sudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\n\nnsenter -t ${firstPid} -n sudo stress-ng --cpu {{ cpu }} --cpu-method matrixprod -t {{ duration }}s \necho Finished CPU stress.\n\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  echo \"Two containers are being targeted on this test...\"\n\n  nsenter -t ${secondPid} -n sudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\n\n  nsenter -t ${secondPid} -n sudo stress-ng --cpu {{ cpu }} --cpu-method matrixprod -t {{ duration }}s \n  echo Finished CPU stress.\nfi\n\nEOF"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-PodStressCPU"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-PodStressCPU"
   }
  },
  "ebtestKillProcessByName": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nIt kills a particular process by name in an instance, using the `killall` command.\n## Input Parameters\n* Process: (Required) Name of the process to kill.\n* Signal: The SIGNAL to be sent along with the kill command (default: SIGTERM). The allowed values are:\n  * SIGTERM: Signal used for gracefully terminate a process. Can be referred as soft kill, because the receiver may choose to ignore it.\n  * SIGKILL: Signal used for immediate termination of a process. Cannot be caught, ignored or blocked. Child processes are killed as well.\n",
     "schemaVersion": "2.2",
     "parameters": {
      "processName": {
       "type": "String",
       "description": "(Required) Name of the process to kill, using the `killall` command. ",
       "allowedPattern": "^[0-9a-zA-Z.\\-=_]{1,128}$"
      },
      "signal": {
       "type": "String",
       "description": "The SIGNAL to be sent along with the kill command (default: SIGTERM).\nThe allowed values are:\n* SIGTERM: Signal used for graceful process termination. Can be referred as soft kill, because the receiver may choose to ignore it.\n* SIGKILL: Signal used for immediate process termination. Cannot be caught, ignored or blocked. Child processes are killed as well.\n",
       "default": "SIGTERM",
       "allowedValues": [
        "SIGTERM",
        "SIGKILL"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "KillProcess",
       "description": "## Parameters: Process\nThis step will kill the specified process, using the `killall` command.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "killall -{{ signal }} {{ processName }}"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-KillProcessByName"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-KillProcessByName"
   }
  },
  "ebtestDetachVolume": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "### Document name - AWSFIS-EBS-Volume-Crash\n## What does this document do?\nIt unmounts and Detach an EBS Volume with a command.\n## Input Parameters\n* Device: (Required) Name of the Volume to unmount.\n* InstanceId: The InstanceId to be whose volume is to be detached\n## Output Parameters\nNone.\n",
     "schemaVersion": "2.2",
     "parameters": {
      "device": {
       "type": "String",
       "description": "(Required) Name of the Device to detach, using the `umount` command",
       "allowedPattern": "^[0-9a-zA-Z.\\-=_/]{1,128}$"
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "name": "DetachVolume",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "description": "## Parameters: Device\nThis step will attempt to detach the volume, using the linux 'umount' command.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "sudo umount -l {{ device }}\necho Done with command: \"DetachVolume\"\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-DetachVolume"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-DetachVolume"
   }
  },
  "ebtestBlackHoleByIPAddress": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Block access to a series of ip addresses on an instance.",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The duration in seconds of the access block.",
       "default": "180",
       "allowedPattern": "^[0-9]+$"
      },
      "ipAddresses": {
       "type": "String",
       "description": "The list of internet addresses to block.  The list must be space delimeted.",
       "default": "3.218.180.0/22 52.119.232.0/21 52.119.224.0/21 52.94.0.0/22"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.  In this case iptables is being installed and an attempt is\nmade to start the service.  iptables should always be installed on the os by default, so this should never happen.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which iptables 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install iptables-services\n      sudo systemctl start iptables\n      sudo systemctl start ip6tables\n      sudo systemctl enable iptables\n      sudo systemctl enable ip6tables\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y iptables\n    sudo ufw enable\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "AlterIPtables",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 300,
        "runCommand": [
         "sudo -s -H <<'EOF'\niptables -S\niptables-save>outputfile;\n\nfor ipa in {{ ipAddresses }}; do\n  sudo iptables -I OUTPUT 1 -d  $ipa -j DROP;\n  sudo iptables -I FORWARD 1 -d  $ipa -j DROP;\n  sudo iptables -t mangle -I OUTPUT 1 -d  $ipa -j DROP;\n  sudo iptables -t mangle -I FORWARD 1 -d  $ipa -j DROP;\n  sudo echo \"$ipa\";\ndone\n\nsleep {{ duration }}s\n\nsudo iptables-restore<outputfile;\n\nsudo rm outputfile;"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-BlackHoleByIPAddress"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-BlackHoleByIPAddress"
   }
  },
  "ebtestPodBlackholeByPort": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Block DNS on one or 2 Core DNS Containers",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The amount of time which the port will be blocked for in minutes. (Required)",
       "default": "2",
       "allowedPattern": "^[0-9]+$"
      },
      "protocol": {
       "type": "String",
       "description": "The protocol.",
       "default": "udp tcp"
      },
      "sourcePorts": {
       "type": "String",
       "description": "The ports to block.",
       "default": ""
      },
      "destinationPorts": {
       "type": "String",
       "description": "The ports to block.",
       "default": ""
      },
      "containerNamePattern": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z_]{1,128}$",
       "default": "k8s_coredns"
      },
      "numContainersToTarget": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "1"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.  In this case iptables is being installed and an attempt is\nmade to start the service.  iptables should always be installed on the os by default, so this should never happen.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which iptables 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install iptables-services\n      sudo systemctl start iptables\n      sudo systemctl start ip6tables\n      sudo systemctl enable iptables\n      sudo systemctl enable ip6tables\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y iptables\n    sudo ufw enable\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "AlterIPtables",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 180,
        "runCommand": [
         "sudo -s -H <<'EOF'\n\necho {{ containerNamePattern }}\n\nfirstPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==1{print $1}' | sed 's/,//')\necho \"${firstPid}\"\nsecondPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==2{print $1}' | sed 's/,//')\necho \"${secondPid}\"\n\nif [ -z \"$firstPid\" ]\nthen\n  echo \"firstPid is NULL\"\n  exit 0\nfi\n\nnsenter -t ${firstPid} -n iptables-save>outputfile;\n\nfor protocol in {{ protocol }}; do\n  if [[ ! -z \"{{ destinationPorts }}\" ]]\n  then\n    nsenter -t ${firstPid} -n iptables -I OUTPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -I FORWARD 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -I INPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -t mangle -I OUTPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -t mangle -I FORWARD 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -t mangle -I INPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n  fi\n\n  if [[ ! -z \"{{ sourcePorts }}\" ]]\n  then\n    nsenter -t ${firstPid} -n iptables -I OUTPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -I FORWARD 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -I INPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -t mangle -I OUTPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -t mangle -I FORWARD 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    nsenter -t ${firstPid} -n iptables -t mangle -I INPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n  fi\n  done\n\n  nsenter -t ${firstPid} -n iptables -S;\n\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  echo \"Two containers are being targeted on this test...\"\n\n  for protocol in {{ protocol }}; do\n    if [[ ! -z \"{{ destinationPorts }}\" ]]\n    then\n      nsenter -t ${secondPid} -n iptables -I OUTPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -I FORWARD 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -I INPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -t mangle -I OUTPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -t mangle -I FORWARD 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -t mangle -I INPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    fi\n\n    if [[ ! -z \"{{ sourcePorts }}\" ]]\n    then\n      nsenter -t ${secondPid} -n iptables -I OUTPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -I FORWARD 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -I INPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -t mangle -I OUTPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -t mangle -I FORWARD 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n      nsenter -t ${secondPid} -n iptables -t mangle -I INPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    fi\n    done\n\n    nsenter -t ${secondPid} -n iptables -S;\nfi\n\necho \"Before sleep...\"\nnsenter -t ${firstPid} -n sleep {{ duration }}m;\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  nsenter -t ${secondPid} -n sleep {{ duration }}m;\nfi\necho \"After sleep...\"\n\necho \"Before restoring iptables rules...\"\nnsenter -t ${firstPid} -n iptables-restore<outputfile;\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  nsenter -t ${secondPid} -n iptables-restore<outputfile;\nfi\necho \"After restoring iptables rules...\"\n\necho \"Before deleting outputfile\"\nnsenter -t ${firstPid} -n rm outputfile;\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  nsenter -t ${secondPid} -n rm outputfile;\nfi\necho \"After deleting output file\"\n\nEOF"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-PodBlackholeByPort"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-PodBlackholeByPort"
   }
  },
  "ebtestDiskVolumeExhaustion": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nIt runs disk filling stress on an instance via stress-ng tool.\nstress-ng --fallocate {{ Workers }} --fallocate-bytes {{ Filesize }} -t {{ Duration }}s\n## Input Parameters\n* Duration: (Required) The duration - in seconds - of the Disk stress.\n* Workers: Specify the number of workers continually fallocating (preallocating file space).\n* Filesize: Allocated  file  size in GB (default  is 1).\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default True)\n",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "(Required) The duration - in seconds - of the Disk stress.",
       "allowedPattern": "^[0-9]+$",
       "default": "60"
      },
      "workers": {
       "type": "String",
       "description": "Specify the number of Fallocate workers to use (default: 4)",
       "default": "4",
       "allowedPattern": "^[0-9]+$"
      },
      "filesize": {
       "type": "String",
       "description": "Specify the Filesize in GB to use (default: 1)",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances (default: True)",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: installDependencies\nIf set to True, this step installs the required dependency via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which stress-ng 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install stress-ng\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y stress-ng\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "ExecuteStressNg",
       "description": "## Parameters: Duration, Workers, Filesize\nThis step will stress the Disk with the specified Filesize for the specified Duration time\nin seconds.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "if [ {{ duration }} -lt 1 ] || [ {{ duration }} -gt 43200 ] ; then echo duration parameter value must be between 1 and 43200 seconds && exit; fi\nsudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\necho Initiating Disk stress for {{ duration }} seconds...\nsudo stress-ng --fallocate {{ workers }} --fallocate-bytes {{ filesize }}g -t {{ duration }}s\necho Finished Disk stress.\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-DiskVolumeExhaustion"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-DiskVolumeExhaustion"
   }
  },
  "ebtestInstallStressNG": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nInstalls Stress-NG on a pod\n",
     "schemaVersion": "2.2",
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installStressNG",
       "description": "This step installs the required dependecy via a bash script.\n",
       "inputs": {
        "runCommand": [
         "#/bin/bash\nDIR=\"/tmp/resiliency/\"\nPOD=$(sudo -u admin kubectl get pods -n resiliency | grep authplugincontainer | awk '{print $1}')\n\nif /bin/mkdir $DIR; then\n  if sudo -u admin kubectl exec -it --namespace resiliency $POD -- /bin/mkdir $DIR; then\n\n    cd $DIR\n    apt-get download $(apt-cache depends --recurse --no-recommends --no-suggests \\\n    --no-conflicts --no-breaks --no-replaces --no-enhances \\\n    --no-pre-depends stress-ng| grep \"^\\w\" | egrep -v \"gcc|libc6|zlib\")\n    for package in ./*deb; do\n      sudo -u admin kubectl cp $package resiliency/$POD:$DIR; done\n          sudo -u admin kubectl exec -it --namespace resiliency $POD -- /bin/bash -c 'dpkg -i '$DIR'*.deb'\n  fi\nfi\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-InstallStressNG"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-InstallStressNG"
   }
  },
  "ebtestStressAllNetworkIO": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Blackhole all Inbound and Outbound Network Traffic",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The duration - in seconds - of the test.",
       "default": "60"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: installDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.  In this case iptables is being installed and an attempt is\nmade to start the service.  iptables should always be installed on the os by default, so this should never happen.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which iptables 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install iptables-services\n      sudo systemctl start iptables\n      sudo systemctl start ip6tables\n      sudo systemctl enable iptables\n      sudo systemctl enable ip6tables\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y iptables\n    sudo ufw enable\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "AlterIPtables",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "#!/bin/bash\n  sudo iptables -I INPUT -m state --state NEW -j DROP\n  sudo iptables -I OUTPUT -m state --state NEW -j DROP\n  sudo iptables -I FORWARD -m state --state NEW -j DROP \n  sudo sleep {{ duration }}s\n  sudo iptables -D INPUT -m state --state NEW -j DROP\n  sudo iptables -D OUTPUT -m state --state NEW -j DROP\n  sudo iptables -D FORWARD -m state --state NEW -j DROP "
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-StressAllNetworkIO"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-StressAllNetworkIO"
   }
  },
  "ebtestStressNetworkUtilization": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nIt simulates high network utilization by limiting bandwidth on the network.\n## Input Parameters\n* Interface: The interface to add delay to (default: eth0).\n* Rate: The outgoing rate - in kbits - to set to the interface (default: 1024).\n* Duration: The duration - in seconds - of the test (default: 60).\n* Port Number:\n* Port Type: Source port or destination port.\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).\n",
     "schemaVersion": "2.2",
     "parameters": {
      "interface": {
       "type": "String",
       "description": "The interface to add delay to (default: eth0).",
       "default": "eth0",
       "allowedPattern": "^[0-9a-zA-Z\\-]{1,15}$"
      },
      "portNumber": {
       "type": "String",
       "description": "The port number on which to limit the bandwidth. (default:80).\nThe allowed values are:\n* PortNumber: The Port No on which the network bandwidth is to be limited.\n",
       "default": "0",
       "allowedPattern": "^[0-9]+$"
      },
      "portType": {
       "type": "String",
       "description": "The port type on which to limit the bandwith. (default:sport).\nThe allowed values are: dport, sport.\n",
       "default": "sport",
       "allowedValues": [
        "dport",
        "sport"
       ]
      },
      "rate": {
       "type": "String",
       "description": "The outgoing rate - in kbits - to add to set the interface (default: 1024).",
       "default": "1024",
       "allowedPattern": "^[0-9]+$"
      },
      "duration": {
       "type": "String",
       "description": "The duration - in seconds - of the test (default: 60).",
       "default": "60",
       "allowedPattern": "^[0-9]+$"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which tc 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install tc\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y iproute2\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "AlterNetworkInterface",
       "description": "## Parameters: interface, delay and duration\nThis step changes the outgoing rate (in kbits) to `Interface` for the given `Duration` (in seconds),\nusing the `tc` (Traffic Control) command.  The script will limit the outgoing bandwidth on the network,\nand wait for the given duration to remove that.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "#!/bin/bash\necho \"Injecting high network utilization ...\"\nif  [[ \"{{ portNumber }}\" == 0 ]] ; then\n  sudo tc qdisc add dev {{ interface }} root tbf rate {{ rate }}kbit latency 50ms burst 1540\n  sudo sleep {{ duration }}s\n  sudo tc qdisc del dev {{ interface }} root\nelse  \n  sudo tc qdisc add dev {{ interface }} root handle 1: prio priomap 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  sudo tc qdisc add dev {{ interface }} parent 1:2 handle 20: tbf rate {{ rate }}kbit latency 50ms burst 1540\n  sudo tc filter add dev {{ interface }} parent 1:0 protocol ip u32 match ip {{portType}} {{ portNumber }} 0xffff flowid 1:2\n  sudo sleep {{ duration }}s\n  sudo tc qdisc del dev {{ interface }} root\nfi"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-StressNetworkUtilization"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-StressNetworkUtilization"
   }
  },
  "ebtestBlackHoleKafka": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Block access to kafka on an instance",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The duration - in minute - of the attack. (Required)",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "kafkanodes": {
       "type": "String",
       "description": "The urls of the Kafka brokers you want to block, separated by a space"
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "name": "RevertCommandScheduling",
       "inputs": {}
      },
      {
       "action": "aws:runShellScript",
       "name": "AlterIptables",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\n\nfor url in {{ kafkanodes }}; do\n  iptables -I OUTPUT 1 -d $url -j DROP;\n  iptables -I FORWARD 1 -d $url -j DROP; \n  iptables -t mangle -I OUTPUT 1 -d $url -j DROP;\n  iptables -t mangle -I FORWARD 1 -d $url -j DROP;\n  done"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-BlackHoleKafka"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-BlackHoleKafka"
   }
  },
  "ebtestPodHealthCheck": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "schemaVersion": "2.2",
     "description": "### Document name - podHealthCheck\n## What does this document do?\n## Output Parameters\n* None.\n",
     "parameters": {
      "clustername": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "blueprint"
      },
      "namespace": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "public"
      },
      "podNamePattern": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z-]{1,128}$",
       "default": "spring-frontend"
      },
      "podHealthPort": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "80"
      },
      "podHealthPath": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "health"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "",
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which stress-ng 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\\$basearch\nenabled=1\ngpgcheck=1\ngpgkey=https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg\nEOF\n      sudo yum install -y kubectl\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo apt-get install -y ca-certificates curl\n    sudo curl -fsSLo /etc/apt/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg\n    echo \"deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main\" | sudo tee /etc/apt/sources.list.d/kubernetes.list\n    sudo apt-get update -y\n    sudo apt-get install -y kubectl\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\nsudo aws eks --region us-east-1 update-kubeconfig --name {{ clustername }}\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "podHealthCheck",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "sudo kubectl get pods -n {{ namespace }} --no-headers=true -o wide --kubeconfig /root/.kube/config |  awk '/{{ podNamePattern }}/{print $6}' | xargs -I % wget -q -O - http://%:{{ podHealthPort }}/{{ podHealthPath }} | jq -r '.status'\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-PodHealthCheck"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-PodHealthCheck"
   }
  },
  "ebtestBlackHoleByPort": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Block all communication on an instance by port and protocol.",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The duration - in seconds - of the attack. (Required)",
       "default": "60",
       "allowedPattern": "^[0-9]+$"
      },
      "protocol": {
       "type": "String",
       "description": "The protocol.",
       "default": "tcp"
      },
      "sourcePorts": {
       "type": "String",
       "description": "The source ports to block.",
       "default": ""
      },
      "destinationPorts": {
       "type": "String",
       "description": "The destination ports to block.",
       "default": ""
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.  In this case iptables is being installed and an attempt is\nmade to start the service.  iptables should always be installed on the os by default, so this should never happen.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which iptables 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install iptables-services\n      sudo systemctl start iptables\n      sudo systemctl start ip6tables\n      sudo systemctl enable iptables\n      sudo systemctl enable ip6tables\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y iptables\n    sudo ufw enable\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "AlterIPtables",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 300,
        "runCommand": [
         "sudo -s -H <<'EOF'\niptables -S\niptables-save>outputfile;\n\nfor protocol in {{ protocol }}; do\n  if [[ ! -z \"{{ destinationPorts }}\" ]]\n  then\n    iptables -I OUTPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    iptables -I FORWARD 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    iptables -I INPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    iptables -t mangle -I OUTPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    iptables -t mangle -I FORWARD 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n    iptables -t mangle -I INPUT 1 -p $protocol --match multiport --dports {{ destinationPorts }} -j DROP;\n  fi\n\n  if [[ ! -z \"{{ sourcePorts }}\" ]]\n  then\n    iptables -I OUTPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    iptables -I FORWARD 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    iptables -I INPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    iptables -t mangle -I OUTPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    iptables -t mangle -I FORWARD 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n    iptables -t mangle -I INPUT 1 -p $protocol --match multiport --sports {{ sourcePorts }} -j DROP;\n  fi\n  done\n\niptables -S\n\necho \"Before sleep...\"\nsleep {{ duration }}s;\necho \"After sleep...\"\n\necho \"Before restoring iptables rules...\"\niptables-restore<outputfile;\necho \"After restoring iptables rules...\"\n\niptables -S\n\nEOF\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-BlackHoleByPort"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-BlackHoleByPort"
   }
  },
  "ebtestShutDownNetworkInterfaceOnInstance": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Block all network traffic on an instance by shutting down the network interface",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The amount of time for which the network interface should remain down. (Required)",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependency via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which ifconfig 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install net-tools\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y net-tools\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "ShutdownNetworkInterface",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "sudo /sbin/ifconfig eth0 down\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-ShutDownNetworkInterfaceOnInstance"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-ShutDownNetworkInterfaceOnInstance"
   }
  },
  "ebtestPodStressIO": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Perfomrs an IO stress test on one or 2 Core DNS Containers\n on an instance via utilizing the stress-ng tool.\n## Input Parameters\n* Duration: (Required) The duration - in seconds - of the IO stress.\n* Iomix: Specify the number of mixed IO stressors to use (default 1)\n* Percent: Specify the percentage of the available file system space used by each stressor. (default 80)\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default True)\n",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The amount of time which for memory will be stressed in seconds. (Required)",
       "default": "60"
      },
      "iomix": {
       "type": "String",
       "description": "Specify the number of mixed IO stressors to use (default 1)",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "percent": {
       "type": "String",
       "description": "Specify the percentage of the available file system space used by each stressor. (default 80)",
       "default": "80",
       "allowedPattern": "^[0-9]+$"
      },
      "containerNamePattern": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z_]{1,128}$",
       "default": "k8s_coredns"
      },
      "numContainersToTarget": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "1"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.  In this case iptables is being installed and an attempt is\nmade to start the service.  iptables should always be installed on the os by default, so this should never happen.\n",
       "inputs": {
        "runCommand": [
         "",
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which stress-ng 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install stress-ng\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y stress-ng\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "StressIO",
       "description": "## Parameters: duration and cpu\nThis step will stress the specified CPU number - or all CPUs if set to 0 (zero) - for the specified duration time\nin seconds.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "sudo -s -H <<'EOF'\n\nif [ {{ duration }} -lt 1 ] || [ {{ duration }} -gt 43200 ] ; then echo Duration parameter value must be between 1 and 43200 seconds && exit; fi\n\necho {{ containerNamePattern }}\n\nfirstCoreDNSPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==1{print $1}' | sed 's/,//')\necho \"${firstCoreDNSPid}\"\nsecondCoreDNSPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==2{print $1}' | sed 's/,//')\necho \"${secondCoreDNSPid}\"\n\nif [ -z \"$firstCoreDNSPid\" ]\nthen\n  echo \"firstCoreDNSPid is NULL\"\n  exit 0\nfi\n\nnsenter -t ${firstCoreDNSPid} -n sudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\n\necho Initiating IO stress for {{ duration }} seconds...\nnsenter -t ${firstCoreDNSPid} -n sudo stress-ng --iomix {{ iomix }} --iomix-bytes {{ percent }}% -t {{ duration }}s \necho Finished IO stress.\n\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  echo \"Two containers are being targeted on this test...\"\n\n  nsenter -t ${secondCoreDNSPid} -n sudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\n\n  echo Initiating IO stress for {{ duration }} seconds...\n  nsenter -t ${firstCoreDNSPid} -n sudo stress-ng --iomix {{ iomix }} --iomix-bytes {{ percent }}% -t {{ duration }}s \n  echo Finished IO stress.\nfi\n\nEOF"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-PodStressIO"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-PodStressIO"
   }
  },
  "ebtestPodStressMemory": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Perfomrs a high memory stress test on one or 2 Core DNS Containers\n on an instance via utilizing the stress-ng tool.\n## Input Parameters\n* Duration: The duration - in seconds - of the memory stress (default: 60).\n* Workers: The number of virtual memory stressors (default: 1).\n* Percent: The percentage of virtual memory to use (default: 80).\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).\n",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The amount of time which for memory will be stressed in seconds. (Required)",
       "default": "60",
       "allowedPattern": "^[0-9]+$"
      },
      "workers": {
       "type": "String",
       "description": "The number of virtual memory stressors (default: 1).",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "percent": {
       "type": "String",
       "description": "The percentage of virtual memory to use (required).",
       "allowedPattern": "^[0-9]+$",
       "default": "80"
      },
      "containerNamePattern": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z_]{1,128}$",
       "default": "k8s_coredns"
      },
      "numContainersToTarget": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "1"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.  In this case iptables is being installed and an attempt is\nmade to start the service.  iptables should always be installed on the os by default, so this should never happen.\n",
       "inputs": {
        "runCommand": [
         "",
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which stress-ng 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install stress-ng\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y stress-ng\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "AlterIPtables",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 180,
        "runCommand": [
         "sudo -s -H <<'EOF'\n\nif [ {{ duration }} -lt 1 ] || [ {{ duration }} -gt 43200 ] ; then echo Duration parameter value must be between 1 and 43200 seconds && exit; fi\n\necho {{ containerNamePattern }}\n\nfirstCoreDNSPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==1{print $1}' | sed 's/,//')\necho \"${firstCoreDNSPid}\"\nsecondCoreDNSPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==2{print $1}' | sed 's/,//')\necho \"${secondCoreDNSPid}\"\n\nif [ -z \"$firstCoreDNSPid\" ]\nthen\n  echo \"firstCoreDNSPid is NULL\"\n  exit 0\nfi\n\nnsenter -t ${firstCoreDNSPid} -n sudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\n\nnsenter -t ${firstCoreDNSPid} -n sudo stress-ng --vm {{ workers }} --vm-bytes {{ percent }}% -t {{ duration }}s\necho Finished memory stress.\n\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  echo \"Two containers are being targeted on this test...\"\n\n  nsenter -t ${secondCoreDNSPid} -n sudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\n\n  nsenter -t ${secondCoreDNSPid} -n sudo stress-ng --vm {{ workers }} --vm-bytes {{ percent }}% -t {{ duration }}s\n  echo Finished memory stress.\nfi\n\nEOF"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-PodStressMemory"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-PodStressMemory"
   }
  },
  "ebtestPodStressNetworkUtilization": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nIt simulates high network utilization by limiting bandwidth on the network\non one or 2 Core DNS Containers\n on an instance via utilizing the stress-ng tool.\n## Input Parameters\n* Interface: The interface to add delay to (default: eth0).\n* Rate: The outgoing rate - in kbits - to set to the interface (default: 1024).\n* Duration: The duration - in seconds - of the test (default: 60).\n* Port Number:\n* Port Type: Source port or destination port.\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).\n",
     "schemaVersion": "2.2",
     "parameters": {
      "interface": {
       "type": "String",
       "description": "The interface to add delay to (default: eth0).",
       "default": "eth0",
       "allowedPattern": "^[0-9a-zA-Z\\-]{1,15}$"
      },
      "iomix": {
       "type": "String",
       "description": "Specify the number of mixed IO stressors to use (default 1)",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "portNumber": {
       "type": "String",
       "description": "The port number on which to limit the bandwidth. (default:80).\nThe allowed values are:\n* PortNumber: The Port No on which the network bandwidth is to be limited.\n",
       "default": "0",
       "allowedPattern": "^[0-9]+$"
      },
      "portType": {
       "type": "String",
       "description": "The port type on which to limit the bandwith. (default:sport).\nThe allowed values are: dport, sport.\n",
       "default": "sport",
       "allowedValues": [
        "dport",
        "sport"
       ]
      },
      "rate": {
       "type": "String",
       "description": "The outgoing rate - in kbits - to add to set the interface (default: 1024).",
       "default": "1024",
       "allowedPattern": "^[0-9]+$"
      },
      "duration": {
       "type": "String",
       "description": "The duration - in seconds - of the test (default: 60).",
       "default": "60",
       "allowedPattern": "^[0-9]+$"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      },
      "containerNamePattern": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z_]{1,128}$",
       "default": "k8s_coredns"
      },
      "percent": {
       "type": "String",
       "description": "Specify the percentage of the available bandwidth used by each stressor. (default 80)",
       "default": "80",
       "allowedPattern": "^[0-9]+$"
      },
      "numContainersToTarget": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "1"
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which tc 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install tc\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y iproute2\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "AlterNetworkInterface",
       "description": "## Parameters: interface, delay and duration\nThis step changes the outgoing rate (in kbits) to `Interface` for the given `Duration` (in seconds),\nusing the `tc` (Traffic Control) command.  The script will limit the outgoing bandwidth on the network,\nand wait for the given duration to remove that.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "sudo -s -H <<'EOF'\n\nif [ {{ duration }} -lt 1 ] || [ {{ duration }} -gt 43200 ] ; then echo Duration parameter value must be between 1 and 43200 seconds && exit; fi\n\necho {{ containerNamePattern }}\n\nfirstCoreDNSPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==1{print $1}' | sed 's/,//')\necho \"${firstCoreDNSPid}\"\nsecondCoreDNSPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==2{print $1}' | sed 's/,//')\necho \"${secondCoreDNSPid}\"\n\nif [ -z \"$firstCoreDNSPid\" ]\nthen\n  echo \"firstCoreDNSPid is NULL\"\n  exit 0\nfi\n\necho \"Injecting high network utilization ...\"\nnsenter -t ${firstCoreDNSPid} -n sudo stress-ng --iomix {{ iomix }} --iomix-bytes {{ percent }}% -t {{ duration }}s \nnsenter -t ${firstCoreDNSPid} -n sudo tc qdisc add dev {{ interface }} root tbf rate {{ rate }}kbit latency 50ms burst 1540\nnsenter -t ${firstCoreDNSPid} -n sudo sleep {{ duration }}s\nnsenter -t ${firstCoreDNSPid} -n sudo tc qdisc del dev {{ interface }} root\necho \"Finished injecting high network utilization ...\"\n\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  echo \"Two containers are being targeted on this test...\"\n\n  echo \"Injecting high network utilization ...\"\n  nsenter -t ${firstCoreDNSPid} -n sudo stress-ng --iomix {{ iomix }} --iomix-bytes {{ percent }}% -t {{ duration }}s \n  nsenter -t ${firstCoreDNSPid} -n sudo tc qdisc add dev {{ interface }} root tbf rate {{ rate }}kbit latency 50ms burst 1540\n  nsenter -t ${firstCoreDNSPid} -n sudo sleep {{ duration }}s\n  nsenter -t ${firstCoreDNSPid} -n sudo tc qdisc del dev {{ interface }} root\n  echo \"Finished injecting high network utilization ...\"\nfi\n\nEOF"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-PodStressNetworkUtilization"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-PodStressNetworkUtilization"
   }
  },
  "ebtestStressCPU": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nIt runs CPU stress on an instance via stress-ng tool.\n## Input Parameters\n* duration: (Required) The duration - in seconds - of the CPU stress.\n* cpu: Specify the number of CPU stressors to use (default 0 = all)\n* installDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default True)\n",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "(Required) The duration - in seconds - of the CPU stress.",
       "allowedPattern": "^[0-9]+$",
       "default": "60"
      },
      "cpu": {
       "type": "String",
       "description": "Specify the number of CPU stressors to use (default: 0 which means \"all CPUs\")",
       "default": "0",
       "allowedPattern": "^[0-9]+$"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances (default: True)",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependency via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which stress-ng 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install stress-ng\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y stress-ng\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "ExecuteStressNg",
       "description": "## Parameters: duration and cpu\nThis step will stress the specified CPU number - or all CPUs if set to 0 (zero) - for the specified duration time\nin seconds.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "if [ {{ duration }} -lt 1 ] || [ {{ duration }} -gt 43200 ] ; then echo duration parameter value must be between 1 and 43200 seconds && exit; fi\nsudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\necho Initiating CPU stress for {{ duration }} seconds...\nsudo stress-ng --cpu {{ cpu }} --cpu-method matrixprod -t {{ duration }}s\necho Finished CPU stress.\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-StressCPU"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-StressCPU"
   }
  },
  "ebtestStressNetworkLatency": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nIt adds latency on the network.\n## Input Parameters\n* Interface: The interface to add delay to (default: eth0).\n* Delay: The delay - in milliseconds - to add to the interface (default: 200).\n* Duration: The duration - in seconds - of the test (default: 60).\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).\n",
     "schemaVersion": "2.2",
     "parameters": {
      "interface": {
       "type": "String",
       "description": "The interface to add delay to (default: eth0).",
       "default": "eth0"
      },
      "ports": {
       "type": "String",
       "description": "The port numbers separated by a space on which to induce the network latency.",
       "default": "0",
       "allowedPattern": "^[0-9]+$"
      },
      "portType": {
       "type": "String",
       "description": "The port type on which to induce the network latency. (default:sport).\nThe allowed values are: dport, sport.\n",
       "default": "sport"
      },
      "delay": {
       "type": "String",
       "description": "The delay - in milliseconds - to add to the interface (default: 100).",
       "default": "100"
      },
      "duration": {
       "type": "String",
       "description": "The duration - in seconds - of the test (default: 60).",
       "default": "60"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True"
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which tc 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install tc\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y iproute2\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "AlterNetworkInterface",
       "description": "## Parameters: interface, delay and duration\nThis step adds a `Delay` (in milliseconds) to `Interface` for the given `Duration` (in seconds), using the `tc` (Traffic Control) command.\nThe script will inject latency on the network, and wait for the given duration to remove that.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "sudo -s -H <<'EOF'\n\necho \"interface\" = {{ interface }}\necho \"delay\" = {{ delay }}\necho \"portType\" = {{ portType }}\necho \"ports\" = {{ ports }}\necho \"duration\" = {{ duration }}\n\necho \"Injecting latency...\"\nif  [[ \"{{ ports }}\" == 0 ]] ; then\n  sudo tc qdisc add dev {{ interface }} root netem delay {{ delay }}ms\n  echo \"Before sleep...\"\n  sleep {{ duration }}s\n  echo \"After sleep...\"\n  echo \"Before removing network latency...\"\n  sudo tc qdisc del dev {{ interface }} root\n  echo \"After removing network latency...\"\nelse\n  for port in {{ ports }}; do\n    tc qdisc add dev {{ interface }} root handle 1: prio priomap 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n    tc qdisc add dev {{ interface }} parent 1:2 handle 20: netem delay '{{ delay }}ms'\n    tc filter add dev {{ interface }} parent 1:0 protocol ip u32 match ip '{{portType}}' $port 0xffff flowid 1:2\n    done\n\n  echo \"Before sleep...\"\n  sleep {{ duration }}s\n  echo \"After sleep...\"\n  tc qdisc del dev {{ interface }} root\n  echo \"Before removing network latency...\"\n  tc qdisc del dev {{ interface }} root\n  echo \"After removing network latency...\"\nfi\nEOF"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-StressNetworkLatency"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-StressNetworkLatency"
   }
  },
  "ebtestStressPacketLoss": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nAdding packet loss to the network\nDrops 7% of packets with 25% correlation\n## Input Parameters\n* Interface: The interface to add delay to (default: eth0).\n* Loss: The percent of packet to drop (default: 7).\n* Correlation: The correlation - in percent - with previous packet loss (default: 25).\n* Duration: The duration - in seconds - of the test (default: 60).\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).\n",
     "schemaVersion": "2.2",
     "parameters": {
      "interface": {
       "type": "String",
       "description": "The interface to add delay to (default: eth0).",
       "default": "eth0"
      },
      "portNumber": {
       "type": "String",
       "description": "The port number on which to induce the network latency. (default:80).\nThe allowed values are:\n* PortNumber: The Port No on which the network latency is to be induced.\n",
       "default": "0"
      },
      "portType": {
       "type": "String",
       "description": "The port type on which to induce the network latency. (default:sport).\nThe allowed values are: dport, sport.\n",
       "default": "sport"
      },
      "loss": {
       "type": "String",
       "description": "The percent of packet to drop. (default: 7).",
       "default": "7"
      },
      "duration": {
       "type": "String",
       "description": "The duration - in seconds - of the test (default: 60).",
       "default": "60"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True"
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: installDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which tc 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install tc\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y iproute2\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "AlterNetworkInterface",
       "description": "## Parameters: interface, loss, and duration\nThis step adds a `Loss` (in percent) to `interface` for the given `duration` (in seconds), using the `tc` (Traffic Control) command.\nThe script will inject packet drop on the network, and wait for the given duration to remove that.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "#!/bin/bash\necho \"Injecting packet drop...\"\nif  [[ \"{{ portNumber }}\" == 0 ]] ; then\n  sudo tc qdisc add dev {{ interface }} root netem loss {{ loss }}%\n  sudo sleep {{ duration }}s\n  sudo tc qdisc del dev {{ interface }} root netem loss {{ loss }}%\nelse  \n  sudo tc qdisc add dev {{ interface }} root handle 1: prio priomap 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\n  sudo tc qdisc add dev {{ interface }} parent 1:2 handle 20: netem loss {{ loss }}%\n  sudo tc filter add dev {{ interface }} parent 1:0 protocol ip u32 match ip {{portType}} {{ portNumber }} 0xffff flowid 1:2\n  sudo sleep {{ duration }}s\n  sudo tc qdisc del dev {{ interface }} root\nfi\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-StressPacketLoss"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-StressPacketLoss"
   }
  },
  "ebtestKillProcess": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nIt kills a particular process by pid in an instance, using the `kill` command.\n## Input Parameters\n* Process: (Required) Pid of the process to kill.\n* Signal: The SIGNAL to be sent along with the kill command (default: SIGTERM). The allowed values are:\n  * SIGTERM: Signal used for gracefully terminate a process. Can be referred as soft kill, because the receiver may choose to ignore it.\n  * SIGKILL: Signal used for immediate termination of a process. Cannot be caught, ignored or blocked. Child processes are killed as well.\n",
     "schemaVersion": "2.2",
     "parameters": {
      "processId": {
       "type": "String",
       "description": "(Required) Pid of the process to kill, using the `kill` command. ",
       "allowedPattern": "^[0-9]{1,128}$"
      },
      "signal": {
       "type": "String",
       "description": "The SIGNAL to be sent along with the kill command (default: SIGTERM).\nThe allowed values are:\n* SIGTERM: Signal used for graceful process termination. Can be referred as soft kill, because the receiver may choose to ignore it.\n* SIGKILL: Signal used for immediate process termination. Cannot be caught, ignored or blocked. Child processes are killed as well.\n",
       "default": "SIGTERM",
       "allowedValues": [
        "SIGTERM",
        "SIGKILL"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "KillProcess",
       "description": "## Parameters: processId\nThis step will kill the specified process, using the `kill` command.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "kill -{{ signal }} {{ processId }}"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-KillProcess"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-KillProcess"
   }
  },
  "ebtestPodStressAllNetworkIO": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Block all ports on one or 2 Core DNS Containers",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The amount of time which the port will be blocked for in minutes. (Required)",
       "default": "2",
       "allowedPattern": "^[0-9]+$"
      },
      "containerNamePattern": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z_]{1,128}$",
       "default": "k8s_coredns"
      },
      "numContainersToTarget": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z]{1,128}$",
       "default": "1"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: InstallDependencies\nIf set to True, this step installs the required dependecy via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.  In this case iptables is being installed and an attempt is\nmade to start the service.  iptables should always be installed on the os by default, so this should never happen.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which iptables 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install iptables-services\n      sudo systemctl start iptables\n      sudo systemctl start ip6tables\n      sudo systemctl enable iptables\n      sudo systemctl enable ip6tables\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y iptables\n    sudo ufw enable\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "name": "AlterIPtables",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 180,
        "runCommand": [
         "sudo -s -H <<'EOF'\n\necho {{ containerNamePattern }}\n\nfirstCoreDNSPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==1{print $1}' | sed 's/,//')\necho \"${firstCoreDNSPid}\"\nsecondCoreDNSPid=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==2{print $1}' | sed 's/,//')\necho \"${secondCoreDNSPid}\"\n\nif [ -z \"$firstCoreDNSPid\" ]\nthen\n  echo \"firstCoreDNSPid is NULL\"\n  exit 0\nfi\n\nnsenter -t ${firstCoreDNSPid} -n iptables-save>outputfile;\n\nnsenter -t ${firstCoreDNSPid} -n sudo iptables -I INPUT -m state --state NEW -j DROP\nnsenter -t ${firstCoreDNSPid} -n iptables -I OUTPUT -m state --state NEW -j DROP\nnsenter -t ${firstCoreDNSPid} -n iptables -I FORWARD -m state --state NEW -j DROP \n\nnsenter -t ${firstCoreDNSPid} -n iptables -S;\n\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  echo \"Two containers are being targeted on this test...\"\n\n  nsenter -t ${secondCoreDNSPid} -n iptables-save>outputfile;\n\n  nsenter -t ${secondCoreDNSPid} -n sudo iptables -I INPUT -m state --state NEW -j DROP\n  nsenter -t ${secondCoreDNSPid} -n iptables -I OUTPUT -m state --state NEW -j DROP\n  nsenter -t ${secondCoreDNSPid} -n iptables -I FORWARD -m state --state NEW -j DROP \n\n  nsenter -t ${secondCoreDNSPid} -n iptables -S;\nfi\n\necho \"Before sleep...\"\nnsenter -t ${firstCoreDNSPid} -n sleep {{ duration }}m;\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  nsenter -t ${secondCoreDNSPid} -n sleep {{ duration }}m;\nfi\necho \"After sleep...\"\n\necho \"Before restoring iptables rules...\"\nnsenter -t ${firstCoreDNSPid} -n iptables-restore<outputfile;\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  nsenter -t ${secondCoreDNSPid} -n iptables-restore<outputfile;\nfi\necho \"After restoring iptables rules...\"\n\necho \"Before deleting outputfile\"\nnsenter -t ${firstCoreDNSPid} -n rm outputfile;\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  nsenter -t ${secondCoreDNSPid} -n rm outputfile;\nfi\necho \"After deleting output file\"\n\nEOF"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-PodStressAllNetworkIO"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-PodStressAllNetworkIO"
   }
  },
  "ebtestPodTerminationCrash": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "Crash 1 or both of the Containers matching the containerNamePattern parameter.",
     "schemaVersion": "2.2",
     "parameters": {
      "containerNamePattern": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9a-zA-Z_]{1,128}$",
       "default": "k8s_coredns"
      },
      "numContainersToTarget": {
       "type": "String",
       "description": "",
       "allowedPattern": "^[0-9]+$",
       "default": "2"
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "name": "PodTerminationCrash",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 180,
        "runCommand": [
         "sudo -s -H <<'EOF'\n\necho {{ containerNamePattern }}\n\nfirstPID=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==1{print $1}' | sed 's/,//')\necho \"${firstPID}\"\nsecondPID=$(docker ps -q | xargs docker inspect --format '{{.State.Pid}}, {{.Name}}' | awk '/{{ containerNamePattern }}/{print $1}' | awk 'NR==2{print $1}' | sed 's/,//')\necho \"${secondPID}\"\n\necho \"Crashing Core DNS...\"\nkill -9 \"${firstPID}\"\nif  [[ \"{{ numContainersToTarget}}\" == '2' ]] ; then\n  kill -9 \"${secondPID}\"\nfi\nEOF\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-PodTerminationCrash"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-PodTerminationCrash"
   }
  },
  "ebtestStressMemory": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nIt runs memory stress on an instance via stress-ng tool.\n## Input Parameters\n* Duration: The duration - in seconds - of the memory stress (default: 60).\n* Workers: The number of virtual memory stressors (default: 1).\n* Percent: The percentage of virtual memory to use (default: 80).\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).\n",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "The duration - in seconds - of the memory stress (default: 60).",
       "default": "60",
       "allowedPattern": "^[0-9]+$"
      },
      "workers": {
       "type": "String",
       "description": "The number of virtual memory stressors (default: 1).",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "percent": {
       "type": "String",
       "description": "The percentage of virtual memory to use (required).",
       "allowedPattern": "^[0-9]+$",
       "default": "80"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances. (default: True).",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "installDependencies",
       "description": "## Parameter: installDependencies\nIf set to True, this step installs the required dependency via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which stress-ng 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install stress-ng\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y stress-ng\n  elif sudo cat /etc/os-release | grep -i debian; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y stress-ng\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "ExecuteStressNg",
       "description": "## Parameters: duration, workers and percent\nThis step will run a memory stress test on the instance for the specified Duration time - in seconds.\nIt will start `Workers` number of workers, using `Percent` of the total available memory.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "if [ {{ duration }} -lt 1 ] || [ {{ duration }} -gt 43200 ] ; then echo Duration parameter value must be between 1 and 43200 seconds && exit; fi\nsudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\necho Initiating memory stress for {{ duration }} seconds, {{ workers }} workers, using {{ percent }} of total available memory...\nsudo stress-ng --vm {{ workers }} --vm-bytes {{ percent }}% -t {{ duration }}s\necho Finished memory stress.\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-StressMemory"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-StressMemory"
   }
  },
  "ebtestStressIO": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "description": "## What does this document do?\nIt runs IO stress on an instance via stress-ng tool.\n## Input Parameters\n* Duration: (Required) The duration - in seconds - of the IO stress.\n* Iomix: Specify the number of mixed IO stressors to use (default 1)\n* Percent: Specify the percentage of the available file system space used by each stressor. (default 80)\n* InstallDependencies: If set to True, Systems Manager installs the required dependencies on the target instances. (default True)\n",
     "schemaVersion": "2.2",
     "parameters": {
      "duration": {
       "type": "String",
       "description": "(Required) The duration - in seconds - of the IO stress.",
       "allowedPattern": "^[0-9]+$",
       "default": "60"
      },
      "iomix": {
       "type": "String",
       "description": "Specify the number of mixed IO stressors to use (default 1)",
       "default": "1",
       "allowedPattern": "^[0-9]+$"
      },
      "percent": {
       "type": "String",
       "description": "Specify the percentage of the available file system space used by each stressor. (default 80)",
       "default": "80",
       "allowedPattern": "^[0-9]+$"
      },
      "installDependencies": {
       "type": "String",
       "description": "If set to True, Systems Manager installs the required dependencies on the target instances (default: True)",
       "default": "True",
       "allowedValues": [
        "True",
        "False"
       ]
      }
     },
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "InstallDependencies",
       "description": "## Parameter: installDependencies\nIf set to True, this step installs the required dependency via operating system's repository. It supports both\nDebian (apt) and CentOS (yum) based package managers.\n",
       "inputs": {
        "runCommand": [
         "#!/bin/bash\nif  [[ \"{{ installDependencies }}\" == True ]] ; then\n  if [[ \"$( which stress-ng 2>/dev/null )\" ]] ; then echo Dependency is already installed. ; exit ; fi\n  echo \"Installing required dependencies\"\n  if [ -f  \"/etc/system-release\" ] ; then\n    if sudo cat /etc/system-release | grep -i 'Amazon Linux' ; then\n      sudo amazon-linux-extras install testing\n      sudo yum -y install stress-ng\n    else\n      echo \"There was a problem installing dependencies.\"\n      exit 1\n    fi\n  elif sudo cat /etc/issue | grep -i Ubuntu ; then\n    sudo apt-get update -y\n    sudo DEBIAN_FRONTEND=noninteractive sudo apt-get install -y stress-ng\n  else\n    echo \"There was a problem installing dependencies.\"\n    exit 1\n  fi\nfi\n"
        ]
       }
      },
      {
       "action": "aws:runShellScript",
       "precondition": {
        "StringEquals": [
         "platformType",
         "Linux"
        ]
       },
       "name": "ExecuteStressNg",
       "description": "## Parameters: duration, iomix, and rrercent\nThis step will perform an IO stress for the specified Duration time\nin seconds.\n",
       "inputs": {
        "maxAttempts": 1,
        "timeoutSeconds": 120,
        "runCommand": [
         "if [ {{ duration }} -lt 1 ] || [ {{ duration }} -gt 43200 ] ; then echo Duration parameter value must be between 1 and 43200 seconds && exit; fi\nsudo pgrep stress-ng && echo Another stress-ng command is running, exiting... && exit\necho Initiating IO stress for {{ duration }} seconds...\nsudo stress-ng --iomix {{ iomix }} --iomix-bytes {{ percent }}% -t {{ duration }}s\necho Finished IO stress.\n"
        ]
       }
      }
     ]
    },
    "DocumentFormat": "YAML",
    "DocumentType": "Command",
    "Name": "eb-test-StressIO"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-StressIO"
   }
  },
  "ebtesttrigger40B69F62": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": {
      "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
     },
     "S3Key": "7181f8c64946704f5ae968025e14581374dd55080e5743740cca9cc5bedff2eb.zip"
    },
    "Environment": {
     "Variables": {
      "STATE_MACHINE_ARN": {
       "Ref": "ebtestStateMachine249346BD"
      },
      "BUCKET_NAME": {
       "Ref": "ebtestsourcebucketB1DEEE4A"
      },
      "EXPERIMENT_PREFIX": "experiments/",
      "RESULT_PREFIX": "journals/"
     }
    },
    "FunctionName": "eb-test-trigger",
    "Handler": "index.lambda_handler",
    "Role": {
     "Fn::GetAtt": [
      "ebtestlambdaroleDE103BD1",
      "Arn"
     ]
    },
    "Runtime": "python3.12",
    "Timeout": 120
   },
   "DependsOn": [
    "ebtestlambdaroleDefaultPolicy2F38B516",
    "ebtestlambdaroleDE103BD1"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-trigger/Resource",
    "aws:asset:path": "asset.7181f8c64946704f5ae968025e14581374dd55080e5743740cca9cc5bedff2eb",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "ebtestjirawriterB6B35CF2": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "S3Bucket": {
      "Fn::Sub": "cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}"
     },
     "S3Key": "765cd1c439a9ac58b1e2c87d0fae2dc66b12ac4ec0e3d5c78f7b4ffa799caf26.zip"
    },
    "Environment": {
     "Variables": {
      "secret_id": "exp-broker-jira-auth"
     }
    },
    "FunctionName": "eb-test-jira-writer",
    "Handler": "journal_writer.handler",
    "Role": {
     "Fn::GetAtt": [
      "ebtestlambdaroleDE103BD1",
      "Arn"
     ]
    },
    "Runtime": "python3.10",
    "Timeout": 60
   },
   "DependsOn": [
    "ebtestlambdaroleDefaultPolicy2F38B516",
    "ebtestlambdaroleDE103BD1"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/eb-test-jira-writer/Resource",
    "aws:asset:path": "asset.765cd1c439a9ac58b1e2c87d0fae2dc66b12ac4ec0e3d5c78f7b4ffa799caf26",
    "aws:asset:is-bundled": false,
    "aws:asset:property": "Code"
   }
  },
  "xrayintegrationpolicyF46033FB": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "secretsmanager:GetSecretValue",
       "Effect": "Allow",
       "Resource": "arn:aws:secretsmanager:*:*:secret:exp-broker-jira-auth*"
      },
      {
       "Action": "s3:GetObject",
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          {
           "Fn::GetAtt": [
            "ebtestsourcebucketB1DEEE4A",
            "Arn"
           ]
          },
          "/journals/*"
         ]
        ]
       }
      },
      {
       "Action": [
        "kms:Decrypt",
        "kms:Encrypt",
        "kms:GenerateDataKey"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ebtestkeyFA6456B8",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "xrayintegrationpolicyF46033FB",
    "Roles": [
     {
      "Ref": "ebtestlambdaroleDE103BD1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/xray-integration-policy/Resource"
   }
  },
  "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/BucketNotificationsHandler050a0587b7544547bf325f094a3db834/Role/Resource"
   }
  },
  "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "s3:PutBucketNotification",
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36",
    "Roles": [
     {
      "Ref": "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/BucketNotificationsHandler050a0587b7544547bf325f094a3db834/Role/DefaultPolicy/Resource"
   }
  },
  "BucketNotificationsHandler050a0587b7544547bf325f094a3db8347ECC3691": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Description": "AWS CloudFormation handler for \"Custom::S3BucketNotifications\" resources (@aws-cdk/aws-s3)",
    "Code": {
     "ZipFile": "import boto3  # type: ignore\nimport json\nimport logging\nimport urllib.request\n\ns3 = boto3.client(\"s3\")\n\nEVENTBRIDGE_CONFIGURATION = 'EventBridgeConfiguration'\nCONFIGURATION_TYPES = [\"TopicConfigurations\", \"QueueConfigurations\", \"LambdaFunctionConfigurations\"]\n\ndef handler(event: dict, context):\n  response_status = \"SUCCESS\"\n  error_message = \"\"\n  try:\n    props = event[\"ResourceProperties\"]\n    notification_configuration = props[\"NotificationConfiguration\"]\n    managed = props.get('Managed', 'true').lower() == 'true'\n    stack_id = event['StackId']\n    old = event.get(\"OldResourceProperties\", {}).get(\"NotificationConfiguration\", {})\n    if managed:\n      config = handle_managed(event[\"RequestType\"], notification_configuration)\n    else:\n      config = handle_unmanaged(props[\"BucketName\"], stack_id, event[\"RequestType\"], notification_configuration, old)\n    s3.put_bucket_notification_configuration(Bucket=props[\"BucketName\"], NotificationConfiguration=config)\n  except Exception as e:\n    logging.exception(\"Failed to put bucket notification configuration\")\n    response_status = \"FAILED\"\n    error_message = f\"Error: {str(e)}. \"\n  finally:\n    submit_response(event, context, response_status, error_message)\n\ndef handle_managed(request_type, notification_configuration):\n  if request_type == 'Delete':\n    return {}\n  return notification_configuration\n\ndef handle_unmanaged(bucket, stack_id, request_type, notification_configuration, old):\n  def with_id(n):\n    n['Id'] = f\"{stack_id}-{hash(json.dumps(n, sort_keys=True))}\"\n    return n\n\n  external_notifications = {}\n  existing_notifications = s3.get_bucket_notification_configuration(Bucket=bucket)\n  for t in CONFIGURATION_TYPES:\n    if request_type == 'Update':\n        ids = [with_id(n) for n in old.get(t, [])]\n        old_incoming_ids = [n['Id'] for n in ids]\n        external_notifications[t] = [n for n in existing_notifications.get(t, []) if not n['Id'] in old_incoming_ids]\n    elif request_type == 'Create':\n        external_notifications[t] = [n for n in existing_notifications.get(t, [])]\n  if EVENTBRIDGE_CONFIGURATION in existing_notifications:\n    external_notifications[EVENTBRIDGE_CONFIGURATION] = existing_notifications[EVENTBRIDGE_CONFIGURATION]\n\n  if request_type == 'Delete':\n    return external_notifications\n\n  notifications = {}\n  for t in CONFIGURATION_TYPES:\n    external = external_notifications.get(t, [])\n    incoming = [with_id(n) for n in notification_configuration.get(t, [])]\n    notifications[t] = external + incoming\n\n  if EVENTBRIDGE_CONFIGURATION in notification_configuration:\n    notifications[EVENTBRIDGE_CONFIGURATION] = notification_configuration[EVENTBRIDGE_CONFIGURATION]\n  elif EVENTBRIDGE_CONFIGURATION in external_notifications:\n    notifications[EVENTBRIDGE_CONFIGURATION] = external_notifications[EVENTBRIDGE_CONFIGURATION]\n\n  return notifications\n\ndef submit_response(event: dict, context, response_status: str, error_message: str):\n  response_body = json.dumps(\n    {\n      \"Status\": response_status,\n      \"Reason\": f\"{error_message}See the details in CloudWatch Log Stream: {context.log_stream_name}\",\n      \"PhysicalResourceId\": event.get(\"PhysicalResourceId\") or event[\"LogicalResourceId\"],\n      \"StackId\": event[\"StackId\"],\n      \"RequestId\": event[\"RequestId\"],\n      \"LogicalResourceId\": event[\"LogicalResourceId\"],\n      \"NoEcho\": False,\n    }\n  ).encode(\"utf-8\")\n  headers = {\"content-type\": \"\", \"content-length\": str(len(response_body))}\n  try:\n    req = urllib.request.Request(url=event[\"ResponseURL\"], headers=headers, data=response_body, method=\"PUT\")\n    with urllib.request.urlopen(req) as response:\n      print(response.read().decode(\"utf-8\"))\n    print(\"Status code: \" + response.reason)\n  except Exception as e:\n      print(\"send(..) failed executing request.urlopen(..): \" + str(e))\n"
    },
    "Handler": "index.handler",
    "Role": {
     "Fn::GetAtt": [
      "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC",
      "Arn"
     ]
    },
    "Runtime": "python3.9",
    "Timeout": 300
   },
   "DependsOn": [
    "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36",
    "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC"
   ],
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/BucketNotificationsHandler050a0587b7544547bf325f094a3db834/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/21T227bMAz9lr4r2pL2B1KnLYq2g+EM2aOhKIzDWZYMXRoYRv59lGzHWbcnHh5J1CF1tOLL1Yp/vxNnt5CHeqFwz/utF7JmRJU9iob3hVHAsqNOMTcKZRfTAV1Y3Tjev0HiKFyYu+f9Y5A1+EiNaAjz6b/yIXkUDi5MiWZ/ELyPN4Bt0Dk0Op54Fx3YHdiUb1FXCrzRz0FLH5kroK0TjlrK/gCtMl0D2vPhos2VYMI58I6vY7gwkCve71oZa+zyjOVhT/q2Ya+HXmZUmODhp9gPkxn4maNyRqKY5KSFCJ5e8xh+CP8iPJxFx3KLnwTnwq/agyU8bRiUjNna09OckvAtyGDRdy/WhDZpuCViK/QqmQqOysXlf2EmWiHpQG7NJx7A3oh27FnYSsRuXL2BI2qcevnKGO0FarAzR0P30B7HJyAVH6KleqhYdjIogf0S6FlOk2fkNA8f1BJVSD3c5LEFS+aD1jj0xqZRzBkZxVRU/N1U1xFM+IuC0pNmx5+kK0LSz5xrOO3fGBniMC+sAGeCJW0ZjcY0cxqv/O/SNLVoWpbsQ+IrcuVo4FJFu5b0i6RCvj67TGFycHoBow/jrPLOn4z+ds+XS/5w99shLmzQHhvgxRD/ABkvwMikAwAA"
   },
   "Metadata": {
    "aws:cdk:path": "ExperimentBrokerStack/CDKMetadata/Default"
   },
   "Condition": "CDKMetadataAvailable"
  }
 },
 "Conditions": {
  "CDKMetadataAvailable": {
   "Fn::Or": [
    {
     "Fn::Or": [
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "af-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-east-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-northeast-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-northeast-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-southeast-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ap-southeast-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "ca-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "cn-north-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "cn-northwest-1"
       ]
      }
     ]
    },
    {
     "Fn::Or": [
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-north-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-west-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-west-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "eu-west-3"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "il-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "me-central-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "me-south-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "sa-east-1"
       ]
      }
     ]
    },
    {
     "Fn::Or": [
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-east-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-east-2"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-west-1"
       ]
      },
      {
       "Fn::Equals": [
        {
         "Ref": "AWS::Region"
        },
        "us-west-2"
       ]
      }
     ]
    }
   ]
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}